#!/usr/bin/env bash

# Under `kubecf` the grootfs data is stored on non-ephemeral storage,
# on PVCs (__Persistent__ volume claims). This means that on restart
# kubecf will see a non-empty disk containing old data. The changes at
# both top and bottom of the script are to ensure that the grootfs
# data directory is restored to a known good state, i.e. the old data
# removed, and any possible permission changes squashed.

# For BOSH these should be no-ops because it should see only an empty
# disk even on restart.

# Clear grootfs data directory
find /var/vcap/data/grootfs/ -iname * -delete

set -e

source /var/vcap/jobs/garden/bin/envs
source /var/vcap/jobs/garden/bin/grootfs-utils
source /var/vcap/packages/greenskeeper/bin/system-preparation

permit_device_control

invoke_thresholder

mkdir -p /var/vcap/data/garden/depot
mkdir -p /var/vcap/data/grootfs/store

<%- if_p('garden.additional_bpm_volumes') { |vols| if vols.include?('/var/vcap/data/rep/shared/garden') -%>
mkdir -p /var/vcap/data/rep/shared/garden
flock /var/vcap/sys/run/garden/mount.lock /bin/bash -c 'if ! grep -q " /var/vcap/data/rep/shared/garden " /proc/self/mountinfo; then mount --bind /var/vcap/data/rep/shared/garden /var/vcap/data/rep/shared/garden; fi'
mount --make-shared /var/vcap/data/rep/shared/garden
<%- end } -%>

# Ensure that runc and container processes can stat everything in the
# grootfs data directory
chmod ugo+rx /var/vcap/data/grootfs
