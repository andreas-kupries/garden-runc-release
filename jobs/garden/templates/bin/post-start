#!/usr/bin/env bash
set -euo pipefail

start="$( date +%s )"
timeout=120

echo "$(date): Pinging garden server..."
i=1

<% if p("garden.listen_network") == "tcp" -%>
cmd='curl -s <%= p("garden.listen_address") %>/ping'
<% else -%>
cmd='echo -e "GET /ping HTTP/1.1\r\n\r\n" | nc -U <%= p("garden.listen_address") %>'
<% end -%>

while [ $(( $(date +%s) - timeout )) -lt "$start" ]; do
  echo "$(date): Attempt $i..."
  if sh -c "${cmd}"; then
    echo "$(date): Success!"
    exit 0
  fi
  i=$((i + 1))
  sleep 1
done

echo "$( date ): Timed out pinging garden server."
exit 1
